<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIELD 1.0 | Intelligence Dashboard</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
    <!-- Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body { background-color: #020617; color: #e2e8f0; font-family: 'Courier New', Courier, monospace; }
        .glass { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.05); }
        .critical-text { color: #ef4444; text-shadow: 0 0 8px rgba(239, 68, 68, 0.6); animation: flash 1.5s infinite; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #network-graph { height: 350px; background: #0f172a; border-radius: 0.5rem; border: 1px solid #1e293b; }
        .scan-line { width: 100%; height: 2px; background: #3b82f6; position: absolute; top: 0; left: 0; animation: scan 3s infinite linear; opacity: 0.5; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        #leaderboard-modal, #about-modal { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-hidden relative">

    <!-- LEADERBOARD MODAL (Hidden) -->
    <div id="leaderboard-modal" class="fixed inset-0 z-[60] bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="glass w-full max-w-4xl h-[80vh] rounded-2xl flex flex-col shadow-2xl border border-slate-700">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
                <h2 class="text-xl font-bold text-white tracking-widest flex items-center gap-3">
                    <span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
                    TARGET LEADERBOARD
                </h2>
                <button onclick="toggleLeaderboard()" class="text-slate-400 hover:text-white hover:bg-red-500/20 px-3 py-1 rounded transition">CLOSE [X]</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 grid grid-cols-2 gap-6">
                <!-- Dealers Column -->
                <div class="bg-slate-900/50 rounded-xl p-4 border border-red-900/30">
                    <h3 class="text-red-400 font-bold mb-4 border-b border-red-900/50 pb-2">TOP HIGH-VALUE TARGETS</h3>
                    <div id="dealer-list" class="space-y-2"></div>
                </div>
                <!-- Buyers Column -->
                <div class="bg-slate-900/50 rounded-xl p-4 border border-blue-900/30">
                    <h3 class="text-blue-400 font-bold mb-4 border-b border-blue-900/50 pb-2">SUSPECTS</h3>
                    <div id="buyer-list" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ABOUT MODAL -->
    <div id="about-modal" class="fixed inset-0 z-[90] bg-black/90 hidden flex items-center justify-center backdrop-blur-md">
        <div class="glass w-full max-w-4xl p-8 rounded-2xl border border-blue-500/30 relative">
            <button onclick="document.getElementById('about-modal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-white">CLOSE [X]</button>
            <h2 class="text-2xl font-bold text-white mb-6">PROJECT SHIELD TEAM</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 text-center">
                    <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto mb-3 flex items-center justify-center text-xl font-bold">S</div>
                    <h3 class="text-white font-bold">Suraj Kumar Das</h3>
                    <p class="text-blue-400 text-xs">Lead Developer</p>
                </div>
                <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 text-center">
                    <div class="w-16 h-16 bg-purple-600 rounded-full mx-auto mb-3 flex items-center justify-center text-xl font-bold">V</div>
                    <h3 class="text-white font-bold">Vedant Sharma</h3>
                    <p class="text-purple-400 text-xs">AI Specialist</p>
                </div>
                <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 text-center">
                    <div class="w-16 h-16 bg-emerald-600 rounded-full mx-auto mb-3 flex items-center justify-center text-xl font-bold">S</div>
                    <h3 class="text-white font-bold">Sejal Jain</h3>
                    <p class="text-emerald-400 text-xs">Frontend Architect</p>
                </div>
            </div>
            <div class="mt-8 text-center"><p class="text-slate-400 text-sm">Developed by Team <b>DEBUG THUG</b></p></div>
        </div>
    </div>

    <!-- LOGIN OVERLAY (The Gatekeeper) -->
    <div id="login-overlay" class="fixed inset-0 z-[100] bg-[#020617] flex flex-col items-center justify-center">
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20"></div>
        <div class="scan-line"></div>
        <div class="glass p-10 rounded-2xl border border-slate-700 text-center max-w-md w-full relative z-10 shadow-2xl">
            <div class="mb-6 flex justify-center">
                <span class="relative flex h-6 w-6"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span class="relative inline-flex rounded-full h-6 w-6 bg-blue-500"></span></span>
            </div>
            <h1 class="text-4xl font-black tracking-widest text-white mb-2">SHIELD <span class="text-blue-500">1.0</span></h1>
            <p class="text-slate-400 text-xs tracking-[0.2em] mb-8">SECURE INTELLIGENCE PORTAL</p>
            <button onclick="loginWithGoogle()" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 rounded text-white font-bold transition shadow-lg flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
                LOGIN WITH GOOGLE
            </button>
            <p id="login-error" class="mt-4 text-red-500 text-xs font-bold hidden"></p>
        </div>
    </div>

    <!-- MAIN APP (Hidden) -->
    <div id="app-content" class="hidden flex-col h-screen">
        <div class="border-b border-slate-800 bg-slate-950/90 p-4 sticky top-0 z-50 backdrop-blur-md">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span></span>
                    <h1 class="text-2xl font-black tracking-widest text-white">SHIELD <span class="text-blue-500">1.0</span></h1>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <div class="text-[10px] text-slate-500 tracking-widest uppercase">Operative</div>
                        <div class="text-xs text-green-400 font-bold" id="user-email">GUEST</div>
                    </div>
                    <img id="user-photo" src="" class="w-8 h-8 rounded-full border border-slate-600 cursor-pointer hover:border-blue-500 transition" onclick="document.getElementById('about-modal').classList.remove('hidden')" title="About Team">
                    <a href="admin.html" class="text-xs bg-red-900/30 hover:bg-red-900/60 text-red-400 border border-red-800 px-3 py-1 rounded transition-colors">ADMIN</a>
                    <button onclick="logout()" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-600 px-3 py-1 rounded transition-colors">LOGOUT</button>
                </div>
            </div>
        </div>

        <div class="flex-1 max-w-7xl mx-auto w-full p-6 grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-y-auto">
            <!-- Left: Stats & Graph -->
            <div class="lg:col-span-2 space-y-6">
                <div class="grid grid-cols-3 gap-4">
                    <div class="glass p-5 rounded-xl text-center"><div class="text-slate-500 text-[10px] uppercase">Intercepts</div><div class="text-2xl font-bold text-white" id="stat-total">--</div></div>
                    <div class="glass p-5 rounded-xl border-l-4 border-red-600 bg-red-900/10 text-center"><div class="text-red-400 text-[10px] uppercase font-bold">Critical Threats</div><div class="text-2xl font-bold critical-text" id="stat-critical">--</div></div>
                    <div class="glass p-5 rounded-xl text-center"><div class="text-slate-500 text-[10px] uppercase">Active Dealers</div><div class="text-2xl font-bold text-blue-400" id="stat-dealers">--</div></div>
                </div>
                <div class="glass p-5 rounded-xl relative">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-bold uppercase text-slate-300">Trafficking Map</h2>
                        <div class="flex gap-2">
                            <button onclick="document.getElementById('about-modal').classList.remove('hidden')" class="bg-slate-700 hover:bg-slate-600 text-white text-[10px] px-3 py-1.5 rounded font-bold transition shadow-lg">ℹ️ ABOUT</button>
                            <button onclick="toggleLeaderboard()" class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] px-3 py-1.5 rounded font-bold transition shadow-lg flex items-center gap-2">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                LEADERBOARD
                            </button>
                        </div>
                    </div>
                    <div id="network-graph"></div>
                </div>
            </div>
            <!-- Right: Feed -->
            <div class="glass rounded-xl overflow-hidden flex flex-col h-[500px] lg:h-[650px] border border-slate-800">
                <div class="p-4 bg-slate-900/80 border-b border-slate-800"><h2 class="text-sm font-bold uppercase text-slate-300">Incoming Intel</h2></div>
                <div class="overflow-y-auto flex-1 p-3 space-y-3" id="feed"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAlUnrGOCvqMe3u5iO9_hmyU_4VX-6KTMc",
            authDomain: "unwantedfinder.firebaseapp.com",
            projectId: "unwantedfinder",
            storageBucket: "unwantedfinder.firebasestorage.app",
            messagingSenderId: "155647389524",
            appId: "1:155647389524:web:28adf9a0bfcbc5fd7fa2c1",
            measurementId: "G-FSGE4LS883"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();
        let graphLinks = []; 

        function loginWithGoogle() {
            auth.signInWithPopup(provider).then((result) => { 
                // Login Successful - Proceed to Permission Check
                requestPermissions(result.user);
            }).catch((e) => { 
                document.getElementById('login-error').innerText = "AUTH ERROR: " + e.message; 
                document.getElementById('login-error').classList.remove('hidden'); 
            });
        }

        function requestPermissions(user) {
            // Ask for Location (Security Theater + Logging)
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => { logAccess(user, pos.coords.latitude, pos.coords.longitude, "GRANTED"); unlock(user); },
                    (err) => { logAccess(user, null, null, "DENIED_LOC"); unlock(user); alert("Location access denied. Standard access granted."); }
                );
            } else { unlock(user); }
            
            // Ask for Camera (Theater only)
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => { stream.getTracks().forEach(t => t.stop()); })
                .catch(e => console.log("Camera denied"));
        }

        function logAccess(user, lat, lng, status) {
            // Save Viewer Info to Firestore
            db.collection('access_logs').add({
                timestamp: new Date(),
                email: user.email,
                name: user.displayName,
                photo: user.photoURL,
                status: status,
                location: lat ? {lat, lng} : "Unknown"
            });
        }

        function unlock(user) {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('app-content').classList.add('flex');
            document.getElementById('user-email').innerText = user.email.split('@')[0].toUpperCase();
            if(user.photoURL) document.getElementById('user-photo').src = user.photoURL;
            initData();
        }

        function logout() { auth.signOut(); window.location.reload(); }

        auth.onAuthStateChanged((user) => { 
            if (user) { 
                // If already logged in, just request permissions again to refresh log
                requestPermissions(user);
            } else {
                document.getElementById('login-overlay').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        // --- DATA STREAMS ---
        function initData() {
            db.collection('shield_stats').doc('overview').onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    document.getElementById('stat-total').innerText = d.total_intel || 0;
                    document.getElementById('stat-critical').innerText = d.critical_threats || 0;
                    document.getElementById('stat-dealers').innerText = d.active_dealers || 0;
                }
            });

            db.collection('shield_intel').orderBy('timestamp', 'desc').limit(50).onSnapshot(snap => {
                const feed = document.getElementById('feed');
                if(snap.empty) { feed.innerHTML = '<div class="p-8 text-center text-slate-500 text-xs">No intel.</div>'; return; }
                feed.innerHTML = snap.docs.map(doc => {
                    const p = doc.data();
                    const isCrit = p.status === 'CRITICAL';
                    const link = p.url || "#";
                    
                    const isTranslated = p.language && p.language !== 'en' && p.original_content;
                    let contentHtml = `<p class="text-xs text-slate-300 mb-3 leading-relaxed border-l border-slate-700 pl-2 ml-1">${p.content}</p>`;
                    if (isTranslated) {
                        contentHtml = `<div class="mb-3 border-l-2 border-yellow-500/50 pl-2 ml-1 bg-yellow-500/5 p-2 rounded-r"><div class="flex items-center gap-2 mb-1"><span class="text-[10px] bg-yellow-500/20 text-yellow-300 px-1 rounded uppercase">${p.language.toUpperCase()}</span><span class="text-[10px] text-slate-400">ORIGINAL TEXT</span></div><p class="text-xs text-slate-300 italic">"${p.original_content}"</p><div class="mt-2 pt-2 border-t border-slate-700/50"><span class="text-[10px] text-green-400">TRANSLATION:</span><p class="text-xs text-white">${p.content}</p></div></div>`;
                    }

                    return `<div class="p-4 rounded-lg bg-slate-800/40 border-l-2 ${isCrit ? 'border-red-500 bg-red-900/5' : 'border-blue-500/50'} hover:bg-slate-800 transition-colors group relative">
                        <div class="flex justify-between items-start mb-2"><div class="flex flex-col"><span class="text-xs font-bold ${isCrit ? 'text-red-400' : 'text-blue-300'}">@${p.user}</span><span class="text-[10px] text-slate-500 uppercase tracking-wide">${p.platform}</span></div><a href="${link}" target="_blank" class="text-[10px] bg-slate-700 hover:bg-blue-600 text-white px-2 py-1 rounded transition-colors border border-slate-600">OPEN ↗</a></div>
                        ${contentHtml}
                        <div class="flex justify-between items-center pt-2 border-t border-slate-800/50"><span class="text-[10px] px-2 py-0.5 rounded ${isCrit ? 'bg-red-500/20 text-red-400 font-bold' : 'bg-slate-700 text-slate-400'}">THREAT: ${p.final_threat || p.risk_score}%</span><span class="text-[10px] text-slate-500 uppercase">${p.type}</span></div>
                    </div>`;
                }).join('');
            });

            db.collection('shield_stats').doc('network_graph').onSnapshot(doc => {
                if(doc.exists && doc.data().links) { graphLinks = doc.data().links; renderGraph(graphLinks); }
            });
        }

        function renderGraph(links) {
            const nodesSet = new Set();
            links.forEach(l => { nodesSet.add(l.source); nodesSet.add(l.target); });
            const nodes = Array.from(nodesSet).map((id, i) => ({ id: id, label: id.substring(0,6), shape: 'dot', color: i%2===0?'#ef4444':'#3b82f6', size: 10 }));
            const edges = links.map(l => ({ from: l.source, to: l.target, color: {color:'#334155'} }));
            new vis.Network(document.getElementById('network-graph'), { nodes, edges }, { interaction: { hover: true } });
        }

        function toggleLeaderboard() {
            const modal = document.getElementById('leaderboard-modal');
            modal.classList.toggle('hidden');
            if(!modal.classList.contains('hidden')) calculateLeaderboard();
        }

        function calculateLeaderboard() {
            if (!graphLinks.length) return;
            const counts = {};
            graphLinks.forEach(l => { counts[l.source] = (counts[l.source] || 0) + 1; counts[l.target] = (counts[l.target] || 0) + 1; });
            const sortedUsers = Object.keys(counts).sort((a,b) => counts[b] - counts[a]);
            let dealersHtml = '';
            let buyersHtml = '';
            sortedUsers.forEach((user, index) => {
                const count = counts[user];
                const isDealer = index % 2 === 0; 
                const profileLink = `https://www.reddit.com/user/${user}`;
                const html = `<div class="flex justify-between items-center p-3 bg-slate-800 rounded mb-2 border border-slate-700 hover:bg-slate-700/50 transition">
                        <div class="flex items-center gap-3"><span class="text-xs text-slate-500 font-mono">#${index+1}</span><span class="font-bold ${isDealer ? 'text-red-300' : 'text-blue-300'}">@${user}</span></div>
                        <div class="flex items-center gap-2"><span class="text-xs bg-slate-700 px-2 py-1 rounded text-white border border-slate-600">${count} Connections</span><a href="${profileLink}" target="_blank" class="text-[10px] bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition-colors shadow-lg font-bold">OPEN PROFILE ↗</a></div>
                    </div>`;
                if (isDealer) dealersHtml += html; else buyersHtml += html;
            });
            document.getElementById('dealer-list').innerHTML = dealersHtml;
            document.getElementById('buyer-list').innerHTML = buyersHtml;
        }
    </script>
</body>
</html>